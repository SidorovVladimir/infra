- name: Ensure project directories exist
  file:
    path: '{{ static_root }}/{{ item.key }}/{{ item.value.version }}'
    state: directory
    mode: '0755'
  loop: '{{ frontends | dict2items }}'
  loop_control:
    label: '{{ item.key }}@{{ item.value.version }}'
  become: true

- name: Download frontend from GitHub Release
  get_url:
    url: 'https://github.com/{{ item.value.artifact_repo }}/releases/download/{{ item.value.version }}/dist.zip'
    dest: '/tmp/{{ item.key }}/dist.zip'
    mode: '0644'
  loop: '{{ frontends | dict2items }}'
  become: true

- name: Extract frontend archive
  unarchive:
    src: '/tmp/{{ item.key }}/dist.zip'
    dest: '{{ static_root }}/{{ item.key }}/{{ item.value.version }}/'
    remote_src: yes
  loop: '{{ frontends | dict2items }}'
  become: true

- name: Update 'current' symlink
  file:
    src: '{{ static_root }}/{{ item.key }}/{{ item.value.version }}'
    dest: '{{ static_root }}/{{ item.key }}/current'
    state: link
    force: yes
  loop: '{{ frontends | dict2items }}'
  become: true

- name: Clean up old versions (keep last 5)
  shell: |
    set -euo pipefail
    cd {{ static_root }}/{{ item.key }}
    # Получаем все папки, начинающиеся с 'v', сортируем как версии, удаляем всё кроме последних 5
    ls -1 | grep '^v' | sort -V | head -n -5 | xargs -r rm -rf
  args:
    executable: /bin/bash
  loop: '{{ frontends | dict2items }}'
  loop_control:
    label: '{{ item.key }}'
  become: true
